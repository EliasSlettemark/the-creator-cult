import OpenAI from "openai";

const openai = new OpenAI({
  apiKey: process.env.OPENAI_API_KEY,
  dangerouslyAllowBrowser: true
});
export const GenerateScript = async (
  productName: string,
  productType: string,
  website: string,
  description: string,
  style: string,
  outline: string,
  user?: any // Mark user as optional
): Promise<{ [key: string]: string }> => {
  if (!user) {
    throw new Error("User is undefined");
  }

  // Create the prompt for the GPT model
  const prompt = `
    Create a marketing script for the following product:
    - Product Name: ${productName}
    - Product Type: ${productType}
    - Website: ${website}
    - Description: ${description}
    - Style: ${style}
    - Outline: ${outline}

    The script might include the following sections:
    Hook:
    Intro:
    Features:
    Social Proof: 
    Call to Action:
    Conclusion:

    Provide the script in a plain text. No title, No styling. PLAIN TEXT AND ONLY USE COLONS FOR SECTIONS. BREAK TEXT BETWEEN SCETIONS.
  `;

  try {
    // Call the OpenAI API
    const response = await openai.chat.completions.create({
      model: "ft:gpt-3.5-turbo-1106:skriptify::9ptuCEx4",  // you can change the fine-tuned model here.
      messages: [{
        "role": "system",
        "content": "ViralifyAI is a tiktok affiliate marketing viral script generator that creates good english, viral scripts, without making stuff up, or assuming things about the product. You're the api skriptify uses."
          },
      { role: "user", content: prompt }],
      temperature: 0.92,
      max_tokens: 700,
      top_p: 0.59,
      frequency_penalty: 0,
      presence_penalty: 0.27,
    });

    const generatedText = response.choices[0].message?.content?.trim();

    

    if (!generatedText) {
      throw new Error("No content generated by OpenAI");
    }

    // Send the generated script via email
    const emailResponse = await fetch('/api/send', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({
        email: user.email,
        firstName: user.name,
        script: generatedText,
      }),
    });

    if (!emailResponse.ok) {
      throw new Error('Failed to send email');
    }

    const emailData = await emailResponse.json();
    console.log('Email sent successfully:', emailData);

          // Split the generated text into the respective parts
            const scriptParts = generatedText.split("\n\n").reduce((acc: { [key: string]: string }, part: string) => {
              const lines = part.split("\n");
              let key = lines[0].split(":")[0].trim();
              const content = lines.slice(1).join("\n").trim();
              
              // Transform the key
              key = key.toLowerCase().replace(/\s+/g, "");
              
              // Special case for "calltoaction"
              if (key === "calltoaction") {
                key = "call to action";
              }
              
              acc[key] = content;
              return acc;
            }, {});

    return scriptParts;
  } catch (error) {
    console.error('Error generating script or sending email:', error);
    throw error;
  }
};